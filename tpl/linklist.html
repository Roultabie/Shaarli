<!DOCTYPE html>
<html>
<head>{include="includes"}</head>
<body>
{include="page.header"}
<div id="linklistpage">
    <div id="searchForm">
        {if="isLoggedIn()"}
        <span><a href="?privateonly">
            {if="$privateonly"}
            <img src="images/private_16x16_active.png#" width="16" height="16" title="Click to see all links" alt="Click to see all links">
            {else}
            <img src="images/private_16x16.png#" width="16" height="16" title="Click to see only private links" alt="Click to see only private links">
            {/if}
            </a></span>
        {/if}
        <span>Links per page: 
            <form method="GET">
                <input type="number" min="1" max="{$linkcount}" value="20" size="2" name="linksperpage">
            </form></span>
        <form method="GET" name="searchform"><input type="text" name="searchterm" value=""> <input type="submit" value="Search"></form>
        <form method="GET" name="tagfilter"><input type="text" name="searchtags" value=""> <input type="submit" value="Filter by tag"></form>
    </div>
    <div id="linklist">
        {include="linklist.paging"}
        {if="count($links)==0"}
            <div id="searchcriteria">
                Nothing found.
            </div>
        {else}
            {if="$search_type=='fulltext'"}
                <div id="searchcriteria">
                    {$result_count} results for <span>{$search_crits}</span>
                </div>
            {/if}
            {if="$search_type=='tags'"}
                <div id="searchcriteria">
                    {$result_count} results for tags <span>{loop="search_crits"}
                        <span title="Remove tag"><a href="?removetag={$value|htmlspecialchars}">{$value|htmlspecialchars} <span>x</span></a></span>
                    {/loop}</span>
                </div>
            {/if}
        {/if}
        <ul>
            {loop="links"}
            <li>
                <a name="{$value.linkdate|smallHash}" id="{$value.linkdate|smallHash}"></a>
                <div>
                    {$value.thumbnail|thumbnail}
                </div>
                <div>
                    {if="isLoggedIn()"}
                        <div class="actions">
                            <form method="GET">
                                <input type="hidden" name="edit_link" value="{$value.linkdate}">
                                <input type="image" alt="Edit" src="images/edit_icon.png#" title="Edit">
                            </form>
                            <form method="POST">
                                <input type="hidden" name="lf_linkdate" value="{$value.linkdate}">
                                <input type="hidden" name="token" value="{$token}">
                                <input type="hidden" name="delete_link">
                                <input type="image" alt="Delete" src="images/delete_icon.png#" title="Delete" onClick="return confirmDeleteLink();">
                            </form>
                        </div>
                    {/if}
                    <span><a href="{$redirector}{$value.url|htmlspecialchars}">{$value.title|htmlspecialchars}</a></span>
                    {if="$value.description"}
                    <div {if condition="$search_type=='permalink'"} class="permalinkSearch"{/if}>
                        {$value.description}
                    </div>
                    {/if}
                    {if="!$GLOBALS['config']['HIDE_TIMESTAMPS'] || isLoggedIn()"}
                        <span title="Permalink"><a href="?{$value.linkdate|smallHash}">{$value.linkdate|linkdate2locale} - permalink</a> - </span>
                    {else}
                        <span title="Short link here"><a href="?{$value.linkdate|smallHash}">permalink</a> - </span>
                    {/if}
                    <div>
                        <a href="http://qrfree.kaywa.com/?l=1&s=8&d={$scripturl|urlencode}%3F{$value.linkdate|smallHash}" 
                        onclick="showQrCode(this); return false;" class="qrcode" data-permalink="{$scripturl}?{$value.linkdate|smallHash}"><img src="images/qrcode.png#" width="13" height="13" title="QR-Code"></a>
                    </div> - 
                    <span title="Short link">{$value.url|htmlspecialchars}</span>
                    {if="$value.tags"}
                        <div>
                            {loop="value.taglist"}<span title="Add tag"><a href="?addtag={$value|urlencode}">{$value|htmlspecialchars}</a></span> {/loop}
                        </div>
                    {/if}
                </div>
            </li>
        {/loop}
        </ul>
        {include="linklist.paging"}
    </div>
</div>
    {include="page.footer"} 
<script language="JavaScript">
// Remove any displayed QR-Code
function remove_qrcode()
{ 
    var elem = document.getElementById("permalinkQrcode");
    if (elem) elem.parentNode.removeChild(elem);
    return false;
}

// Show the QR-Code of a permalink (when the QR-Code icon is clicked).
function showQrCode(caller,loading=false)
{ 
    // Dynamic javascript lib loading: We only load qr.js if the QR code icon is clicked:
    if (typeof(qr)=='undefined') // Load qr.js only if not present.
    {
        if (!loading)  // If javascript lib is still loading, do not append script to body.
        {
            var element = document.createElement("script");
            element.src = "inc/qr.min.js";
            document.body.appendChild(element);
        }
        setTimeout(function() { showQrCode(caller,true);}, 200); // Retry in 200 milliseconds.
        return false;
    }

    // Remove previous qrcode if present.
    remove_qrcode();
    
    // Build the div which contains the QR-Code:
    var element = document.createElement('div');
    element.id="permalinkQrcode";
	// Make QR-Code div commit sepuku when clicked:
    if ( element.attachEvent ){ element.attachEvent('onclick', 'this.parentNode.removeChild(this);' ); } // Damn IE
    else { element.setAttribute('onclick', 'this.parentNode.removeChild(this);' ); }
    
    // Build the QR-Code:
    var image = qr.image({size: 8,value: caller.dataset.permalink});
    if (image)
    { 
        element.appendChild(image);
        element.innerHTML+= "<br>Click to close";
        caller.parentNode.appendChild(element);
    }
    else
    {
        element.innerHTML="Your browser does not seem to be HTML5 compatible.";
    }
    return false;
}
</script>
</body>
</html>
